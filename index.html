<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGA - Syst√®me Gestion Agents</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icons/icon-72x72.png">
    <meta name="theme-color" content="#2c3e50">
    <style>
        /* Style minimal pour le loader */
        #appLoader {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #2c3e50;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 99999;
        }
        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #3498db;
            border-top: 5px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loader-text {
            color: white;
            margin-top: 20px;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <!-- √âcran de chargement -->
    <div id="appLoader">
        <div class="loader-spinner"></div>
        <div class="loader-text" id="loaderMessage">Chargement de l'application...</div>
    </div>

    <!-- Interface principale (cach√©e pendant le chargement) -->
    <div id="mainApp" style="display: none;">
        <!-- En-t√™te -->
        <header class="app-header">
            <div class="header-content">
                <h1>üìã SYSTEME DE GESTION DES AGENTS</h1>
                <p class="subtitle" id="pageSubtitle">Menu Principal</p>
            </div>
            <div class="header-actions">
                <button id="backBtn" class="btn-icon" title="Retour" style="display:none">‚Üê</button>
                <button id="syncBtn" class="btn-icon" title="Synchroniser">üîÑ</button>
                <button id="themeBtn" class="btn-icon" title="Changer th√®me">üåô</button>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="horizontal-nav" id="topNav">
            <button class="nav-tab active" data-page="menu">üè† Accueil</button>
            <button class="nav-tab" data-page="agents">üë• Agents</button>
            <button class="nav-tab" data-page="planning">üìÖ Planning</button>
            <button class="nav-tab" data-page="stats">üìä Stats</button>
            <button class="nav-tab" data-page="radios">üìª Radios</button>
            <button class="nav-tab" data-page="panique">üö® Panique</button>
            <button class="nav-tab" data-page="habillement">üëï Habillement</button>
            <button class="nav-tab" data-page="avertissements">‚ö†Ô∏è Avertissements</button>
            <button class="nav-tab" data-page="conges">üèñÔ∏è Cong√©s</button>
            <button class="nav-tab" data-page="outils">üõ†Ô∏è Outils</button>
        </nav>

        <!-- Contenu principal -->
        <main class="main-content">
            <div id="pageMenu" class="page active">
                <div class="menu-grid"></div>
            </div>
            <div id="pageAgents" class="page"><div class="page-content" id="agentsContent"></div></div>
            <div id="pagePlanning" class="page"><div class="page-content" id="planningContent"></div></div>
            <div id="pageStats" class="page"><div class="page-content" id="statsContent"></div></div>
            <div id="pageRadios" class="page"><div class="page-content" id="radiosContent"></div></div>
            <div id="pagePanique" class="page"><div class="page-content" id="paniqueContent"></div></div>
            <div id="pageHabillement" class="page"><div class="page-content" id="habillementContent"></div></div>
            <div id="pageAvertissements" class="page"><div class="page-content" id="avertissementsContent"></div></div>
            <div id="pageConges" class="page"><div class="page-content" id="congesContent"></div></div>
            <div id="pageOutils" class="page"><div class="page-content" id="outilsContent"></div></div>
        </main>

        <!-- Footer -->
        <footer class="app-footer">
            <div class="footer-info">
                <span id="dbInfo">Base: Chargement...</span>
                <span id="syncStatus">‚ö° En ligne</span>
            </div>
            <div class="footer-version">SGA PWA v1.0 | ¬© 2024</div>
        </footer>

        <!-- Modal -->
        <div id="modalOverlay" class="modal-overlay" style="display:none"></div>
        <div id="modalContainer" class="modal-container" style="display:none"></div>
    </div>

    <!-- Scripts int√©gr√©s DIRECTEMENT dans le HTML pour √©viter les probl√®mes de chargement -->
    <script>
        // ==================== SGA_Database (version simplifi√©e) ====================
        console.log('üì¶ D√©finition de SGA_Database...');
        class SGA_Database {
            constructor() {
                this.db = null;
                this.dbName = 'SGA_DB_v1';
                console.log('‚úÖ SGA_Database cr√©√©');
            }
            
            async initialize() {
                console.log('üîÑ Initialisation de la base de donn√©es...');
                return new Promise((resolve) => {
                    setTimeout(() => {
                        console.log('‚úÖ Base de donn√©es initialis√©e');
                        resolve();
                    }, 100);
                });
            }
            
            async listerAgents() {
                console.log('üìã Liste des agents demand√©e');
                return [
                    { code: 'CPA', nom: 'Agent', prenom: 'Principal', groupe: 'A', date_entree: '2024-01-01', statut: 'actif' },
                    { code: 'CONA', nom: 'Contr√¥le', prenom: 'Agent', groupe: 'B', date_entree: '2024-01-01', statut: 'actif' },
                    { code: 'ZA', nom: 'Zone', prenom: 'Agent', groupe: 'C', date_entree: '2024-01-01', statut: 'actif' }
                ];
            }
            
            async obtenirAgent(code) {
                console.log(`üîç Recherche agent: ${code}`);
                const agents = await this.listerAgents();
                return agents.find(a => a.code === code) || null;
            }
            
            async ajouterAgent(agent) {
                console.log(`‚ûï Ajout agent: ${agent.code}`);
                return true;
            }
            
            async obtenirStatsGlobales() {
                return {
                    totalAgents: 3,
                    totalRadios: 0,
                    agentsActifs: 3
                };
            }
        }
        
        // ==================== PlanningEngine (version simplifi√©e) ====================
        console.log('üì¶ D√©finition de PlanningEngine...');
        class PlanningEngine {
            constructor(db) {
                this.db = db;
                console.log('‚úÖ PlanningEngine cr√©√©');
            }
            
            async genererPlanningTheorique(codeAgent, mois, annee) {
                console.log(`üìÖ G√©n√©ration planning pour ${codeAgent} - ${mois}/${annee}`);
                // Simuler un planning
                const jours = [];
                for (let i = 1; i <= 30; i++) {
                    const shifts = ['1', '2', '3', 'R'];
                    const shift = shifts[Math.floor(Math.random() * shifts.length)];
                    jours.push({
                        jour: i,
                        jour_semaine: ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'][(i-1) % 7],
                        shift: shift,
                        est_dimanche: (i % 7 === 0),
                        ferie: false
                    });
                }
                return jours;
            }
            
            async calculerStatsAgent(code, mois, annee) {
                console.log(`üìä Calcul stats pour ${code}`);
                return {
                    shift1: 7,
                    shift2: 8,
                    shift3: 7,
                    repos: 8,
                    conges: 0,
                    maladie: 0,
                    absence: 0,
                    totalOperationnels: 22,
                    totalJours: 30,
                    joursTravailles: 22,
                    tauxPresence: 73.3
                };
            }
        }
        
        // ==================== ExportUtils (version simplifi√©e) ====================
        console.log('üì¶ D√©finition de ExportUtils...');
        class ExportUtils {
            constructor(db) {
                this.db = db;
                this.planningEngine = null;
                console.log('‚úÖ ExportUtils cr√©√©');
            }
            
            setPlanningEngine(planningEngine) {
                this.planningEngine = planningEngine;
                console.log('‚úÖ PlanningEngine li√© √† ExportUtils');
            }
        }
        
        // ==================== DatabaseManager ====================
        console.log('üì¶ D√©finition de DatabaseManager...');
        class DatabaseManager extends SGA_Database {
            constructor() {
                super();
                console.log('‚úÖ DatabaseManager cr√©√©');
            }
        }
        
        console.log('üéâ Toutes les classes de base sont d√©finies!');
    </script>

    <!-- Chargement DYNAMIQUE et S√âCURIS√â de app.js -->
    <script>
        console.log('üîÑ D√©but du chargement dynamique...');
        const loader = document.getElementById('appLoader');
        const mainApp = document.getElementById('mainApp');
        const loaderMessage = document.getElementById('loaderMessage');
        
        // Fonction pour charger un script dynamiquement
        function loadScript(url, onSuccess, onError) {
            loaderMessage.textContent = `Chargement: ${url}...`;
            
            const script = document.createElement('script');
            script.src = url;
            script.onload = function() {
                console.log(`‚úÖ ${url} charg√© avec succ√®s`);
                if (onSuccess) onSuccess();
            };
            script.onerror = function() {
                console.error(`‚ùå √âchec du chargement: ${url}`);
                if (onError) onError(url);
            };
            document.head.appendChild(script);
        }
        
        // Fonction pour v√©rifier si SGA_App est disponible
        function checkSGAApp() {
            if (typeof SGA_App !== 'undefined') {
                console.log('‚úÖ SGA_App est disponible');
                return true;
            }
            return false;
        }
        
        // S√©quence de chargement principale
        async function initializeApp() {
            try {
                // √âtape 1: Cr√©er les instances de base
                loaderMessage.textContent = 'Cr√©ation des instances...';
                window.db = new DatabaseManager();
                window.planningEngine = new PlanningEngine(window.db);
                window.exportUtils = new ExportUtils(window.db);
                window.exportUtils.setPlanningEngine(window.planningEngine);
                
                // √âtape 2: Essayer de charger app.js
                loaderMessage.textContent = 'Chargement du module principal...';
                
                const appLoaded = await new Promise((resolve) => {
                    // Essayer de charger app.js
                    loadScript(
                        'app.js',
                        function() {
                            // V√©rifier que SGA_App est maintenant disponible
                            if (checkSGAApp()) {
                                resolve(true);
                            } else {
                                // Si app.js ne d√©finit pas SGA_App, on le cr√©e manuellement
                                console.log('‚ö†Ô∏è app.js ne d√©finit pas SGA_App, cr√©ation manuelle...');
                                if (typeof window.SGA_App === 'undefined') {
                                    // Version minimale de SGA_App
                                    window.SGA_App = class SGA_App {
                                        constructor() {
                                            this.db = window.db;
                                            this.planningEngine = window.planningEngine;
                                            this.currentPage = 'menu';
                                            console.log('‚úÖ SGA_App cr√©√© manuellement');
                                        }
                                        async initialize() {
                                            console.log('‚úÖ Application initialis√©e');
                                            // Afficher l'interface
                                            loader.style.display = 'none';
                                            mainApp.style.display = 'block';
                                        }
                                        navigateTo(page) {
                                            console.log(`Navigation vers: ${page}`);
                                            document.getElementById('pageSubtitle').textContent = page;
                                        }
                                    };
                                }
                                resolve(true);
                            }
                        },
                        function(failedUrl) {
                            console.error(`Impossible de charger ${failedUrl}`);
                            // Cr√©er une version de secours de SGA_App
                            if (typeof window.SGA_App === 'undefined') {
                                window.SGA_App = class SGA_App {
                                    constructor() {
                                        this.db = window.db;
                                        this.planningEngine = window.planningEngine;
                                        this.currentPage = 'menu';
                                        console.log('‚úÖ SGA_App cr√©√© (version de secours)');
                                    }
                                    async initialize() {
                                        console.log('‚úÖ Application initialis√©e (version de secours)');
                                        // Afficher l'interface
                                        loader.style.display = 'none';
                                        mainApp.style.display = 'block';
                                        
                                        // Configurer les √©v√©nements de base
                                        document.querySelectorAll('.nav-tab').forEach(tab => {
                                            tab.addEventListener('click', (e) => {
                                                const page = e.target.dataset.page;
                                                this.navigateTo(page);
                                            });
                                        });
                                        
                                        // Afficher le menu principal
                                        this.showMainMenu();
                                    }
                                    navigateTo(page) {
                                        console.log(`Navigation vers: ${page}`);
                                        document.getElementById('pageSubtitle').textContent = page;
                                        // Masquer toutes les pages
                                        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                                        // Afficher la page s√©lectionn√©e
                                        document.getElementById(`page${page.charAt(0).toUpperCase() + page.slice(1)}`).classList.add('active');
                                    }
                                    showMainMenu() {
                                        const menuGrid = document.querySelector('.menu-grid');
                                        menuGrid.innerHTML = `
                                            <div class="menu-card" onclick="sgaApp.navigateTo('agents')">
                                                <h3><span>üë•</span> GESTION DES AGENTS</h3>
                                                <p>Ajouter, modifier, lister, importer agents</p>
                                            </div>
                                            <div class="menu-card" onclick="sgaApp.navigateTo('planning')">
                                                <h3><span>üìÖ</span> GESTION DU PLANNING</h3>
                                                <p>Planning global, par agent, par groupe</p>
                                            </div>
                                            <div class="menu-card" onclick="sgaApp.navigateTo('stats')">
                                                <h3><span>üìä</span> STATISTIQUES</h3>
                                                <p>Stats agents, groupes, export Excel/PDF</p>
                                            </div>
                                        `;
                                    }
                                };
                            }
                            resolve(true); // On continue m√™me avec la version de secours
                        }
                    );
                });
                
                if (appLoaded) {
                    // √âtape 3: Initialiser l'application
                    loaderMessage.textContent = 'Initialisation en cours...';
                    
                    // Attendre un peu pour √™tre s√ªr que tout est charg√©
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // Cr√©er l'instance principale
                    if (typeof SGA_App !== 'undefined') {
                        window.sgaApp = new SGA_App();
                        window.sgaApp.db = window.db;
                        window.sgaApp.planningEngine = window.planningEngine;
                        window.sgaApp.exportUtils = window.exportUtils;
                        
                        // Initialiser l'application
                        await window.sgaApp.initialize();
                    } else {
                        console.error('‚ùå SGA_App non disponible apr√®s chargement');
                        throw new Error('SGA_App non disponible');
                    }
                    
                    // √âtape 4: Afficher l'application
                    loader.style.display = 'none';
                    mainApp.style.display = 'block';
                    
                    console.log('üéâ Application SGA pr√™te!');
                    
                } else {
                    throw new Error('√âchec du chargement de app.js');
                }
                
            } catch (error) {
                console.error('‚ùå Erreur critique:', error);
                loaderMessage.textContent = `Erreur: ${error.message}. Rechargez la page.`;
                loader.innerHTML += `
                    <div style="margin-top: 20px; color: #ff9999;">
                        <p><strong>D√©pannage:</strong></p>
                        <button onclick="location.reload()" style="
                            background: #3498db;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 5px;
                            margin: 5px;
                        ">üîÑ Recharger</button>
                        <button onclick="localStorage.clear(); location.reload()" style="
                            background: #e74c3c;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 5px;
                            margin: 5px;
                        ">üßπ R√©initialiser</button>
                    </div>
                `;
            }
        }
        
        // D√©marrer l'initialisation quand la page est pr√™te
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>